<script type="text/javascript">
	RED.nodes.registerType('publicKey', {
		category: 'config',
		defaults: {
			name: { value: 'publicKey', required: true },
			originContextNode: { value: '' },
			importData: { value: '' },
			isUpload: { value: false },
		},
		label: function () {
			return this.name;
		},
		oneditprepare: function () {
			const contextSmallName = 'Small [default]';
			const contextMediumName = 'Medium [default]';
			const contextLargeName = 'Large [default]';
			const id = this.id;
			const contextNodes = [];
			const isUpload = this.isUpload;
			var importData = this.importData;

			const parseKey = {
				lineLength: 64,
				beginParms: '|------------------------BEGIN PARMS---------------------------|',
				beginKeyId: '|------------------------BEGIN KEYID---------------------------|',
				beginPbKey: '|------------------------BEGIN PBKEY---------------------------|',

				stringLengthLimter: function (string, lineLength) {
					let exportText = '';
					j = 0;
					for (let i = 0; i < string.length; i++) {
						if (j < lineLength) {
							exportText += string[i];
						} else if (j == lineLength) {
							exportText += '\n';
							i--;
							j = -1;
						}
						j++;
					}
					return exportText[exportText.length - 1] !== '\n'
						? exportText + '\n'
						: exportText;
				},

				exportPublicKey: function (keyId, parmsBase64, publicKeyBase64) {
					console.log(this.lineLength);
					let exportText = '';
					exportText += this.beginKeyId + '\n';
					exportText += keyId + '\n';
					exportText += this.beginParms + '\n';
					exportText += this.stringLengthLimter(parmsBase64, this.lineLength);
					exportText += this.beginPbKey + '\n';
					exportText += this.stringLengthLimter(publicKeyBase64, this.lineLength);
					return exportText[exportText.length - 1] === '\n'
						? exportText.slice(0, -1)
						: exportText;
				},
			};

			if (
				this.name === contextSmallName ||
				this.name === contextMediumName ||
				this.name === contextLargeName
			) {
				$('#download-button').click(function () {
					$.getJSON(
						`${
							RED.settings.httpNodeRoot == '/' ? '' : RED.settings.httpNodeRoot
						}/publicKey/${id}`,
					)
						.then(data => {
							const exportData = parseKey.exportPublicKey(
								data.keyId,
								data.parmsBase64,
								data.publicKeyBase64,
							);

							$('<a/>', {
								download: `[${data._name}] PK-KEYID:${data.keyId}` + '.txt',
								href: `data:text/plain;charset=utf-8,${exportData}`,
							})
								.appendTo('body')[0]
								.click();
							$(window).one('focus', function () {
								$('a').last().remove();
							});
						})
						.catch(err => {
							//todo
							console.error(err);
						});
				});
				$('#content').hide();
				$('#upload-button').hide();
				$('#context-button').hide();
				return;
			}

			RED.nodes.eachConfig(function (configNode) {
				if (configNode.type === 'context') {
					contextNodes.push({ value: configNode.id, label: configNode.name });
				}
			});

			$('#node-config-input-originContextNode').typedInput({
				types: [
					{
						value: 'originContextNode',
						options: contextNodes,
					},
				],
			});

			$('#node-config-input-sealNode').hide();
			$('#node-config-input-isUpload').hide();

			if (isUpload) {
				$('#upload').show();
				$('#context').hide();
			} else {
				$('#context').show();
				$('#upload').hide();
			}

			$('#upload-button').click(function () {
				$('#node-config-input-isUpload').prop('checked', true);
				$('#upload').show();
				$('#context').hide();
			});

			$('#context-button').click(function () {
				$('#node-config-input-isUpload').prop('checked', false);
				$('#context').show();
				$('#upload').hide();
			});

			$('#download-button').click(function () {
				$.getJSON(
					`${
						RED.settings.httpNodeRoot == '/' ? '' : RED.settings.httpNodeRoot
					}/publicKey/${id}`,
				)
					.then(data => {
						const exportData = parseKey.exportPublicKey(
							data.keyId,
							data.parmsBase64,
							data.publicKeyBase64,
						);

						$('<a/>', {
							download: `[${data._name}] PK-KEYID:${data.keyId}` + '.txt',
							href: `data:text/plain;charset=utf-8,${exportData}`,
						})
							.appendTo('body')[0]
							.click();
						$(window).one('focus', function () {
							$('a').last().remove();
						});
					})
					.catch(err => {
						//todo
						console.error(err);
					});
			});

			$('#node-config-importData').change(function () {
				const [file] = this.files;
				const fr = new FileReader();
				fr.addEventListener(
					'load',
					() => {
						importData = fr.result;
						$('#node-config-input-importData').val(importData);
						console.log('TESTTESTESTSET');
					},
					false,
				);

				if (file) {
					fr.readAsText(file);
				}
			});
		},
		oneditsave: function () {},
	});
</script>

<script type="text/html" data-template-name="publicKey">
	<div class="form-row">
		<button type="button" class="red-ui-button" id="upload-button">Upload</button>
		<button type="button" class="red-ui-button" id="context-button">Config</button>
		<button type="button" class="red-ui-button" id="download-button">Download</button>
	</div>

	<div id="content">
		<input type="checkbox" id="node-config-input-isUpload" />

		<div id="context">
			<input type="text" id="node-config-input-originContextNode" />
		</div>

		<div id="upload">
			<input type="file" id="node-config-importData" /><br />
			<!-- <input type="text" id="node-config-input-importData" style="width: 100%; height:200px" /> -->
			<textarea
				type="text"
				id="node-config-input-importData"
				style="width: 100%; height:300px"
			>
			</textarea>
		</div>
		<div class="form-row">
			<label for="node-config-input-name"><i class="fa fa-bookmark"></i>Name</label>
			<input type="text" id="node-config-input-name" />
		</div>
	</div>
</script>
