<script type="text/javascript">
	var testNode = null;
	(function ($) {
		RED.nodes.registerType('ckks-sidebar', {
			category: 'config',
			defaults: {
				name: { value: 'ckks-sidebar', required: true },
			},
			label: function () {
				return this.name;
			},
			onpaletteadd: () => {
				console.log('test log from sidebar');
				// const content = $('<div>').css({ position: 'relative', height: '100%' });

				// (optional) A toolbar header for the sidebar
				// const header = $('<div>', { class: 'red-ui-sidebar-header' }).appendTo(content);

				const content = $(
					$('script[type="text/html"][data-template-name="ckks_config_sidebar"]').html(),
				);

				RED.actions.add('my-custom-tab:show-custom-tab', function () {
					RED.sidebar.show('my-custom-tab');
				});

				RED.sidebar.addTab({
					id: 'ckks-context-tab',
					label: 'ckks-context',
					name: 'CipherFlow Config',
					iconClass: 'fa fa-file',
					content: content,
					action: 'my-custom-tab:show-custom-tab',
				});

				$('#ckks-download').click(function (e) {
					// e.preventDefault();
					$.getJSON('/ckks-context/8192').then(data => {
						$('<a/>', {
							download: $.now() + '.txt',
							href: `data:text/plain;charset=utf-8,${data.secretKey}`,
						})
							.appendTo('body')[0]
							.click();
						$(window).one('focus', function () {
							$('a').last().remove();
						});
					});
				});

				$('#ckks-test').click(function () {
					RED.nodes.eachConfig(function (configNode) {
						if (configNode.type == 'ckks-context') {
							testNode = configNode;
							console.log(testNode);
						}
					});
					console.log('end');
				});

				$('#ckks-edit').click(function () {
					RED.editor.editConfig('', testNode.type, testNode.id);
					RED.nodes.dirty(true);
				});

				$('#ckks-add').click(function () {
					const newNode = {
						id: RED.nodes.id(),
						_def: RED.nodes.getType('ckks-context'),
						type: 'ckks-context',
						hasUsers: false,
						users: [],
						name: $.now(),
						label: function () {
							return this.name || $.now();
						},
					};
					RED.nodes.add(newNode);

					// RED.editor.editConfig('', newNode.type, newNode.id);

					RED.nodes.dirty(true);
				});
			},
		});
	})(jQuery);
</script>

<script type="text/html" data-template-name="ckks_config_sidebar">
	<div style="position: relative; height: 100%;">
		<div
			style="position: absolute; top: 1px; bottom: 2px; left: 1px; right: 1px; overflow-y: scroll; padding: 10px;"
		>
			<form class="dialog-form">
				<div class="red-ui-tabs">
					<ul id="dashboard-tabs-list">
						<li class="red-ui-tab active" style="width:70px;">
							<a class="red-ui-tab-label" title="Site" style="width:60px;"
								><span>Config</span></a
							>
						</li>
						<!-- <li class="red-ui-tab" style="width:70px;">
							<a class="red-ui-tab-label" title="Theme" style="width:80px;"
								><span>TAB2</span></a
							>
						</li> -->
					</ul>
				</div>
				<div id="node-ckks-tabs-content" style="height:calc(100% - 100px)">
					<!-- Content of all tabsheets -->
					<!-- <div
						id="node-ckks-tab-terminal"
						class="node-ckks-tab-terminal"
						style="height: 100%; position: relative; margin-top: 30px;"
					>
						<div class="form-row compact">
							<div><b>Title</b></div>
							<input type="text" id="nr-db-field-title" style="width: 100%" />
						</div>
						<div class="form-row compact">
							<div><b>Options</b></div>
							<select id="nr-db-field-hideToolbar" style="width: 100%">
								<option value="false" selected="selected">
									Show the title bar
								</option>
								<option value="true">Hide the title bar</option>
							</select>
						</div>
						<div class="form-row compact">
							<select id="nr-db-field-lockMenu" style="width: 100%">
								<option value="false" selected="selected">
									Click to show side menu
								</option>
								<option value="true">Always show side menu</option>
								<option value="icon">Always show icons only</option>
							</select>
						</div> -->
						<div class="form-row compact">
							<select id="nr-db-field-allowSwipe" style="width: 100%">
								<option value="false" selected="selected">
									No swipe between tabs
								</option>
								<option value="true">Allow swipe between tabs</option>
								<option value="mouse">Allow swipe (+mouse) between tabs</option>
								<option value="menu">Swipe to open/close menu</option>
							</select>
						</div>

						<div class="form-row compact">
							<div
								type="button"
								id="ckks-test"
								class="primary ui-button ui-corner-all ui-widget"
							>
								test
							</div>
						</div>

						<div class="form-row compact">
							<div
								type="button"
								id="ckks-edit"
								class="primary ui-button ui-corner-all ui-widget"
							>
								edit
							</div>
						</div>

						<div class="form-row compact">
							<div
								type="button"
								id="ckks-add"
								class="primary ui-button ui-corner-all ui-widget"
							>
								add
							</div>
						</div>

						<div class="form-row compact">
							<div
								type="button"
								id="ckks-download"
								class="primary ui-button ui-corner-all ui-widget"
							>
								Download
							</div>
						</div>




					</div>
					<div
						id="node-ckks-tab-settings"
						class="node-ckks-tab-settings"
						style="position: relative; margin-top: 30px;"
					>
						<!-- The config node settings (from data-template-name="xterm_config") will be added here -->
					</div>
				</div>
			</form>
		</div>
	</div>
</script>
